# v1.4.4 Comprehensive Enhancement Plan

> **Summary**: Skills, Agents, Hooks, Templates의 유기적 연동 강화를 통한 bkit Philosophy 완전 충족
>
> **Project**: bkit Vibecoding Kit
> **Version**: 1.4.4
> **Author**: Claude Opus 4.5
> **Date**: 2026-01-27
> **Status**: Draft

---

## 1. Overview

### 1.1 Purpose

bkit v1.4.4의 철학(Automation First, No Guessing, Docs = Code)을 완벽하게 구현하기 위해 Skills, Agents, Hooks, Templates의 유기적 연동을 강화한다.

### 1.2 Background

현재 상태 분석 (docs/03-analysis/bkit-codebase-comprehensive-analysis.md):
- **철학 충족도**: 93.4% (목표: 98%+)
- **Skills-Agents 연결**: 55% (6/11 Agents 연결됨)
- **플랫폼 호환성**: 85% (Claude 100%, Gemini 70%)

### 1.3 Related Documents

- [bkit-codebase-comprehensive-analysis.md](../../03-analysis/bkit-codebase-comprehensive-analysis.md)
- [v1.4.4-gap-analysis-10-perspectives.md](../../03-analysis/v1.4.4-gap-analysis-10-perspectives.md)

---

## 2. 10가지 관점 요구사항

### 관점 1: Hooks 라이프사이클과 Philosophy 충족

| 요구사항 | 현재 상태 | 목표 |
|----------|----------|------|
| SessionStart → PDCA 온보딩 | ✅ 구현됨 | 유지 |
| UserPromptSubmit → 의도 감지 | ✅ 구현됨 | 강화 |
| PreToolUse → PDCA 문서 확인 | ✅ 구현됨 | 유지 |
| PostToolUse(Write) → 상태 업데이트 | ✅ 구현됨 | 유지 |
| PostToolUse(Skill) → 다음 단계 제안 | ✅ 구현됨 | 강화 |
| PreCompact → 상태 보존 | ✅ 구현됨 | 유지 |
| **Stop Hooks → Agent 완료 처리** | ⚠️ 부분 구현 | **강화** |

**개선 필요:**
- Stop Hook에서 Agent 결과 기반 자동 다음 단계 트리거
- PDCA Phase 자동 전환 로직 강화

### 관점 2: Skills 전용 (Commands 병용 제거)

| 요구사항 | 현재 상태 | 목표 |
|----------|----------|------|
| Commands DEPRECATED 처리 | ✅ 완료 | 유지 |
| Skills로 완전 마이그레이션 | ✅ 완료 | 유지 |
| DEPRECATED.md 마이그레이션 가이드 | ✅ 완료 | 유지 |
| **commands/backup/ 폴더 정리** | ⚠️ 남아있음 | **삭제** |

### 관점 3: Skills-Agents-Task 유기적 동작

| 요구사항 | 현재 상태 | 목표 |
|----------|----------|------|
| PDCA Skill → gap-detector Agent | ❌ 미연결 | **연결** |
| PDCA Skill → pdca-iterator Agent | ❌ 미연결 | **연결** |
| PDCA Skill → report-generator Agent | ❌ 미연결 | **연결** |
| Task blockedBy PDCA 의존성 | ⚠️ 문서만 | **자동화** |
| enterprise Skill → enterprise-expert | ❌ infra-architect만 | **추가** |
| design-validator → Skill 연결 | ❌ 미연결 | **연결** |
| code-analyzer → Skill 연결 | ❌ 트리거만 | **연결** |

### 관점 4: PDCA 사이클 반복 자동화

| 요구사항 | 현재 상태 | 목표 |
|----------|----------|------|
| Plan → Design 자동 전환 | ⚠️ 수동 | **자동 제안** |
| Design → Do 자동 전환 | ⚠️ 수동 | **자동 제안** |
| Do → Check 자동 트리거 | ⚠️ 제안만 | **자동화** |
| Check < 90% → Act 자동 트리거 | ⚠️ Stop hook만 | **강화** |
| Check ≥ 90% → Report 자동 제안 | ✅ 구현됨 | 유지 |
| Task blockedBy 자동 설정 | ⚠️ 부분 | **완전 자동** |

### 관점 5: Level 자동 감지 및 적절한 Skills 트리거

| 요구사항 | 현재 상태 | 목표 |
|----------|----------|------|
| Level 자동 감지 | ✅ detectLevel() | 유지 |
| Starter → starter-guide Agent | ✅ 연결됨 | 유지 |
| Dynamic → bkend-expert Agent | ✅ 연결됨 | 유지 |
| Enterprise → enterprise-expert Agent | ❌ infra-architect만 | **추가** |
| Level별 Template 자동 선택 | ⚠️ 부분 | **자동화** |

### 관점 6: 9단계 Pipeline 유기적 순서 동작

| 요구사항 | 현재 상태 | 목표 |
|----------|----------|------|
| Phase 1-9 Skills의 next-skill | ✅ 구현됨 | 유지 |
| Phase Skills의 pdca-phase | ✅ 구현됨 | 유지 |
| Phase Stop Hooks | ⚠️ 일부만 | **모두 구현** |
| Phase 전환 시 Task 자동 생성 | ⚠️ 부분 | **완전 자동** |
| Level별 Phase Skip 로직 | ⚠️ 문서만 | **자동화** |

### 관점 7: Templates의 Skills 연동

| 요구사항 | 현재 상태 | 목표 |
|----------|----------|------|
| @import directive | ✅ 구현됨 | 유지 |
| pdca skill → 5개 template imports | ✅ 구현됨 | 유지 |
| Phase Skills → pipeline templates | ⚠️ 부분 | **모두 연결** |
| Level Skills → design templates | ✅ 구현됨 | 유지 |
| Shared templates 활용 | ⚠️ 3개만 | **확장** |

### 관점 8: Templates 문서 충분성

| 요구사항 | 현재 상태 | 목표 |
|----------|----------|------|
| PDCA 5개 템플릿 | ✅ 완료 | 유지 |
| Pipeline 10개 템플릿 | ✅ 완료 | 유지 |
| Level별 Design 3개 | ✅ 완료 | 유지 |
| **iteration-report.template.md** | ⚠️ 존재 미확인 | **확인/생성** |
| **convention.template.md** | ❌ 없음 | **생성** |
| **schema.template.md** | ❌ 없음 | **생성** |

### 관점 9: Templates 항목 범용성

| 요구사항 | 현재 상태 | 목표 |
|----------|----------|------|
| plan.template.md 항목 | ✅ 충분 | 유지 |
| design.template.md 항목 | ✅ 충분 | 유지 |
| analysis.template.md 항목 | ✅ 충분 | 유지 |
| **do.template.md 체크리스트** | ⚠️ 기본만 | **확장** |
| **shared/api-patterns.md** | ⚠️ 기본만 | **확장** |
| **shared/error-handling-patterns.md** | ⚠️ 기본만 | **확장** |

### 관점 10: Skills 로드 시 유기적 연동

| 요구사항 | 현재 상태 | 목표 |
|----------|----------|------|
| Skill frontmatter agent: 필드 | ⚠️ 6개만 | **11개 모두** |
| Skill frontmatter hooks: 필드 | ✅ 구현됨 | 유지 |
| Skill frontmatter imports: 필드 | ✅ 구현됨 | 강화 |
| skill-orchestrator.js 동작 | ✅ 구현됨 | 강화 |
| **Agent multi-binding 지원** | ❌ 없음 | **구현** |

---

## 3. 상세 개선 항목

### 3.1 Skills-Agents 연결 강화 (HIGH)

#### 3.1.1 pdca skill의 Action별 Agent 연결

**현재 상태:**
```yaml
# skills/pdca/SKILL.md
---
name: pdca
# agent: 필드 없음, 본문에서만 언급
---
```

**개선안 A: agents 필드 추가 (권장)**
```yaml
---
name: pdca
agents:
  analyze: gap-detector
  iterate: pdca-iterator
  report: report-generator
hooks:
  Stop:
    - matcher: "gap-detector"
      hooks:
        - type: command
          command: "node ${CLAUDE_PLUGIN_ROOT}/scripts/gap-detector-stop.js"
    - matcher: "pdca-iterator"
      hooks:
        - type: command
          command: "node ${CLAUDE_PLUGIN_ROOT}/scripts/iterator-stop.js"
---
```

**개선안 B: Action별 Sub-skill 분리**
```
skills/
├── pdca/SKILL.md           # 통합 진입점
├── pdca-analyze/SKILL.md   # agent: gap-detector
├── pdca-iterate/SKILL.md   # agent: pdca-iterator
└── pdca-report/SKILL.md    # agent: report-generator
```

#### 3.1.2 enterprise skill의 enterprise-expert 연결

**현재 상태:**
```yaml
# skills/enterprise/SKILL.md
---
agent: infra-architect  # enterprise-expert가 아님
---
```

**개선안:**
```yaml
---
name: enterprise
agents:
  init: enterprise-expert
  infra: infra-architect
---
```

#### 3.1.3 design-validator Skill 연결

**개선안: phase-8-review skill에 연결**
```yaml
# skills/phase-8-review/SKILL.md
---
agent: design-validator  # 또는 code-analyzer와 함께
---
```

#### 3.1.4 code-analyzer Skill 연결

**개선안: phase-7-seo-security 또는 새 skill 생성**
```yaml
# skills/code-review/SKILL.md (신규)
---
name: code-review
agent: code-analyzer
---
```

### 3.2 lib/skill-orchestrator.js 강화 (HIGH)

**현재 상태:**
- `parseSkillFrontmatter()` - agent 필드 단일 값만 지원
- `orchestrateSkillPost()` - 단일 agent 참조만

**개선안:**
```javascript
// lib/skill-orchestrator.js 확장

/**
 * Parse agents field (supports single value and object)
 * @param {Object} frontmatter
 * @returns {Object} agents mapping { action: agentName }
 */
function parseAgentsField(frontmatter) {
  const agents = frontmatter.agents || frontmatter.agent;

  if (typeof agents === 'string') {
    return { default: agents };
  }

  if (typeof agents === 'object') {
    return agents;
  }

  return {};
}

/**
 * Get agent for specific action
 * @param {string} skillName
 * @param {string} action
 * @returns {string|null} agent name
 */
function getAgentForAction(skillName, action) {
  const config = getSkillConfig(skillName);
  const agents = parseAgentsField(config);

  return agents[action] || agents.default || null;
}
```

### 3.3 Stop Hooks 강화 (HIGH)

#### 3.3.1 gap-detector-stop.js 개선

**현재:** Match Rate 기반 옵션 제시
**개선:** 자동 다음 단계 트리거 + Task 자동 생성

```javascript
// scripts/gap-detector-stop.js 개선안
const matchRate = result.matchRate || 0;

// 자동 Task 생성
if (matchRate < 90) {
  await createTask({
    subject: `[Act-${iterationCount}] ${featureName}`,
    description: `Gap Analysis ${matchRate}% - 자동 개선 필요`,
    blockedBy: [`[Check] ${featureName}`]
  });
}

// 자동 다음 단계 제안
if (matchRate < 70) {
  output.autoTrigger = 'pdca-iterator';
  output.message = `매치율 ${matchRate}%로 낮음. pdca-iterator 자동 실행을 권장합니다.`;
}
```

### 3.4 Templates 보완 (MEDIUM)

#### 3.4.1 누락 템플릿 생성

| 템플릿 | 용도 | 우선순위 |
|--------|------|:--------:|
| `iteration-report.template.md` | Act 단계 반복 보고서 | HIGH |
| `convention.template.md` | Phase 2 컨벤션 문서 | MEDIUM |
| `schema.template.md` | Phase 1 스키마 문서 | MEDIUM |

#### 3.4.2 기존 템플릿 확장

**do.template.md 체크리스트 확장:**
```markdown
### 5.3 Implementation Checklist (Expanded)

- [ ] **Architecture Check**
  - [ ] Clean Architecture layer 준수
  - [ ] Import 방향 올바름
  - [ ] Domain 독립성 유지

- [ ] **Convention Check**
  - [ ] Naming convention 준수
  - [ ] File 구조 convention 준수
  - [ ] Import order 준수

- [ ] **Security Check**
  - [ ] Input validation 완료
  - [ ] Auth/Authz 처리
  - [ ] Sensitive data 암호화
```

### 3.5 PDCA 자동 전환 로직 (MEDIUM)

#### 3.5.1 pdca-skill-stop.js 개선

```javascript
// scripts/pdca-skill-stop.js 개선안

const currentPhase = getPdcaPhase(featureName);
const nextPhaseMap = {
  'plan': { next: 'design', skill: '/pdca design' },
  'design': { next: 'do', skill: null },
  'do': { next: 'check', skill: '/pdca analyze' },
  'check': { next: 'act', skill: '/pdca iterate', condition: 'matchRate < 90' },
  'act': { next: 'check', skill: '/pdca analyze' }
};

const transition = nextPhaseMap[currentPhase];
if (transition) {
  // Task 자동 생성
  await createTask({
    subject: `[${capitalize(transition.next)}] ${featureName}`,
    blockedBy: [`[${capitalize(currentPhase)}] ${featureName}`]
  });

  // 다음 단계 제안
  output.nextPhase = transition.next;
  output.suggestedSkill = transition.skill;
}
```

### 3.6 Pipeline Phase 순서 자동화 (MEDIUM)

#### 3.6.1 Phase Stop Hooks 완성

**누락된 Stop Hooks:**

| Phase | Stop Hook | 상태 |
|-------|-----------|:----:|
| Phase 1 | phase1-schema-stop.js | ✅ |
| Phase 2 | phase2-convention-stop.js | ✅ |
| Phase 3 | phase3-mockup-stop.js | ✅ |
| Phase 4 | phase4-api-stop.js | ✅ |
| Phase 5 | phase5-design-stop.js | ✅ |
| Phase 6 | phase6-ui-stop.js | ✅ |
| Phase 7 | phase7-seo-stop.js | ✅ |
| Phase 8 | phase8-review-stop.js | ✅ |
| Phase 9 | phase9-deploy-stop.js | ✅ |

**개선:** 모든 Phase Stop Hook에서 다음 Phase 자동 제안

### 3.7 Level별 자동화 강화 (MEDIUM)

#### 3.7.1 Level별 Phase Skip 자동화

```javascript
// lib/common.js 추가

const LEVEL_PHASE_MAP = {
  'starter': [1, 2, 3, 6, 9],  // Phase 4, 5, 7, 8 skip
  'dynamic': [1, 2, 3, 4, 5, 6, 7, 9],  // Phase 8 optional
  'enterprise': [1, 2, 3, 4, 5, 6, 7, 8, 9]  // All phases
};

function getNextPhaseForLevel(currentPhase, level) {
  const phases = LEVEL_PHASE_MAP[level];
  const currentIndex = phases.indexOf(currentPhase);
  if (currentIndex < phases.length - 1) {
    return phases[currentIndex + 1];
  }
  return null;
}
```

### 3.8 Gemini CLI 호환성 강화 (LOW)

#### 3.8.1 Hook 시스템 대안

**현재:** Gemini CLI는 hooks.json 미지원
**개선:** extension.json의 hooks 섹션 활용 (이미 구현됨)

```json
// gemini-extension.json
{
  "hooks": {
    "SessionStart": { ... },
    "BeforeTool": [ ... ],
    "AfterTool": [ ... ],
    "AgentStop": [ ... ]
  }
}
```

#### 3.8.2 Task System Fallback

**개선:** Gemini CLI에서 Task 대신 파일 기반 상태 관리 강화

---

## 4. Scope

### 4.1 In Scope

- [x] Skills-Agents 연결 강화 (pdca, enterprise, phase-8)
- [x] lib/skill-orchestrator.js 확장 (agents multi-binding)
- [x] Stop Hooks 자동화 강화
- [x] 누락 Templates 생성
- [x] PDCA 자동 전환 로직
- [x] Level별 Phase Skip 자동화
- [x] commands/backup/ 폴더 정리

### 4.2 Out of Scope

- Commands 완전 삭제 (v2.0.0)
- MCP Integration 신규 기능
- 역방향 동기화 (Code → Design) (v1.5.0)
- 멀티 Feature 자동 컨텍스트 전환 (v1.6.0)

---

## 5. Requirements

### 5.1 Functional Requirements

| ID | Requirement | Priority | Status |
|----|-------------|----------|--------|
| FR-01 | pdca skill에 gap-detector, pdca-iterator, report-generator 연결 | High | Pending |
| FR-02 | enterprise skill에 enterprise-expert Agent 추가 | High | Pending |
| FR-03 | phase-8-review skill에 design-validator 연결 | Medium | Pending |
| FR-04 | code-review skill 생성 및 code-analyzer 연결 | Medium | Pending |
| FR-05 | skill-orchestrator.js agents multi-binding 지원 | High | Pending |
| FR-06 | Stop Hooks 자동 다음 단계 트리거 | High | Pending |
| FR-07 | PDCA Phase 자동 전환 Task 생성 | High | Pending |
| FR-08 | iteration-report.template.md 생성 | Medium | Pending |
| FR-09 | convention.template.md 생성 | Low | Pending |
| FR-10 | schema.template.md 생성 | Low | Pending |
| FR-11 | Level별 Phase Skip 자동화 | Medium | Pending |
| FR-12 | commands/backup/ 폴더 삭제 | Low | Pending |

### 5.2 Non-Functional Requirements

| Category | Criteria | Measurement Method |
|----------|----------|-------------------|
| 철학 충족도 | 98% 이상 | Philosophy Compliance Score |
| Skills-Agents 연결 | 100% (11/11) | Agent 연결률 |
| 플랫폼 호환성 | 90% 이상 | Claude/Gemini 테스트 |

---

## 6. Success Criteria

### 6.1 Definition of Done

- [ ] 모든 11개 Agents가 Skills에 연결됨
- [ ] skill-orchestrator.js agents multi-binding 지원
- [ ] 모든 Stop Hooks에서 자동 다음 단계 제안
- [ ] PDCA Phase 전환 시 Task 자동 생성
- [ ] 누락된 Templates 모두 생성
- [ ] commands/backup/ 폴더 삭제
- [ ] Gap Analysis 90% 이상 달성

### 6.2 Quality Criteria

- [ ] 기존 기능 regression 없음
- [ ] Gemini CLI 호환성 유지
- [ ] 모든 scripts 에러 없이 실행

---

## 7. Risks and Mitigation

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| agents multi-binding 호환성 | Medium | Medium | 단일 agent 필드 fallback 유지 |
| 자동화 과도로 사용자 혼란 | Medium | Low | Magic Word Bypass 유지 |
| Gemini CLI hooks 차이 | Low | Low | 플랫폼 감지 분기 |

---

## 8. Architecture Considerations

### 8.1 Project Level Selection

| Level | Characteristics | Recommended For | Selected |
|-------|-----------------|-----------------|:--------:|
| **Dynamic** | Feature-based modules, services layer | Web apps with backend, SaaS MVPs | ☑ |

### 8.2 Key Architectural Decisions

| Decision | Options | Selected | Rationale |
|----------|---------|----------|-----------|
| Agent Binding | Single / Multi | Multi | Action별 다른 Agent 필요 |
| Auto-trigger | Manual / Semi-auto / Full-auto | Semi-auto | 사용자 확인 후 실행 |
| Template Loading | Lazy / Eager | Lazy | 성능 최적화 |

---

## 9. 구현 순서 및 Task 분리

### 9.1 Phase 1: Core Infrastructure (HIGH)

| Task | 예상 파일 | 변경량 |
|------|----------|:------:|
| T1.1 skill-orchestrator.js agents multi-binding | lib/skill-orchestrator.js | ~50 lines |
| T1.2 pdca skill agents 연결 | skills/pdca/SKILL.md | ~20 lines |
| T1.3 enterprise skill agents 연결 | skills/enterprise/SKILL.md | ~10 lines |

### 9.2 Phase 2: Stop Hooks Enhancement (HIGH)

| Task | 예상 파일 | 변경량 |
|------|----------|:------:|
| T2.1 gap-detector-stop.js 자동화 | scripts/gap-detector-stop.js | ~30 lines |
| T2.2 pdca-skill-stop.js 전환 로직 | scripts/pdca-skill-stop.js | ~40 lines |
| T2.3 iterator-stop.js 재검증 트리거 | scripts/iterator-stop.js | ~20 lines |

### 9.3 Phase 3: Agent-Skill Connections (MEDIUM)

| Task | 예상 파일 | 변경량 |
|------|----------|:------:|
| T3.1 phase-8-review + design-validator | skills/phase-8-review/SKILL.md | ~10 lines |
| T3.2 code-review skill 생성 | skills/code-review/SKILL.md | ~50 lines (신규) |

### 9.4 Phase 4: Templates Completion (MEDIUM)

| Task | 예상 파일 | 변경량 |
|------|----------|:------:|
| T4.1 iteration-report.template.md | templates/iteration-report.template.md | 확인/생성 |
| T4.2 convention.template.md | templates/pipeline/convention.template.md | ~100 lines (신규) |
| T4.3 schema.template.md | templates/pipeline/schema.template.md | ~80 lines (신규) |
| T4.4 do.template.md 체크리스트 확장 | templates/do.template.md | ~30 lines |

### 9.5 Phase 5: Pipeline Automation (MEDIUM)

| Task | 예상 파일 | 변경량 |
|------|----------|:------:|
| T5.1 Level별 Phase Skip 로직 | lib/common.js | ~30 lines |
| T5.2 Phase Stop Hooks 통일 | scripts/phase*-stop.js | 검토/수정 |

### 9.6 Phase 6: Cleanup (LOW)

| Task | 예상 파일 | 변경량 |
|------|----------|:------:|
| T6.1 commands/backup/ 삭제 | commands/backup/ | 삭제 |
| T6.2 문서 정리 | README, CHANGELOG | 업데이트 |

---

## 10. Skills-Agents-Templates 연계 맵 (개선 후)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    v1.4.4 Skills-Agents-Templates Integration               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ PDCA Skills Layer                                                        ││
│  │                                                                          ││
│  │ /pdca (통합 Skill)                                                      ││
│  │ ├── plan action                                                          ││
│  │ │   └── imports: plan.template.md                                        ││
│  │ │   └── Task: [Plan] {feature}                                           ││
│  │ ├── design action                                                        ││
│  │ │   └── imports: design.template.md (Level별)                            ││
│  │ │   └── Task: [Design] {feature} (blockedBy: Plan)                       ││
│  │ ├── do action                                                            ││
│  │ │   └── imports: do.template.md                                          ││
│  │ │   └── Task: [Do] {feature} (blockedBy: Design)                         ││
│  │ ├── analyze action ────────────► gap-detector Agent (NEW)               ││
│  │ │   └── imports: analysis.template.md                                    ││
│  │ │   └── Task: [Check] {feature} (blockedBy: Do)                          ││
│  │ │   └── Stop Hook: gap-detector-stop.js                                  ││
│  │ ├── iterate action ────────────► pdca-iterator Agent (NEW)              ││
│  │ │   └── imports: iteration-report.template.md                            ││
│  │ │   └── Task: [Act-N] {feature} (blockedBy: Check)                       ││
│  │ │   └── Stop Hook: iterator-stop.js → 재검증 자동 트리거                ││
│  │ └── report action ─────────────► report-generator Agent (NEW)           ││
│  │     └── imports: report.template.md                                      ││
│  │     └── Task: [Report] {feature}                                         ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ Level Skills Layer                                                       ││
│  │                                                                          ││
│  │ /starter ──────────────────────► starter-guide Agent                    ││
│  │ └── imports: design-starter.template.md                                  ││
│  │ └── next-skill: phase-1-schema                                           ││
│  │                                                                          ││
│  │ /dynamic ──────────────────────► bkend-expert Agent                     ││
│  │ └── imports: design.template.md                                          ││
│  │ └── next-skill: phase-1-schema                                           ││
│  │                                                                          ││
│  │ /enterprise                                                              ││
│  │ ├── init action ───────────────► enterprise-expert Agent (NEW)          ││
│  │ └── infra action ──────────────► infra-architect Agent                  ││
│  │ └── imports: design-enterprise.template.md                               ││
│  │ └── next-skill: phase-1-schema                                           ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ Pipeline Skills Layer                                                    ││
│  │                                                                          ││
│  │ /development-pipeline ─────────► pipeline-guide Agent                   ││
│  │                                                                          ││
│  │ /phase-1-schema ───────────────► (Level별 분기)                         ││
│  │ └── imports: phase-1-schema.template.md                                  ││
│  │ └── next-skill: phase-2-convention                                       ││
│  │ └── Task: [Phase-1] {feature}                                            ││
│  │                                                                          ││
│  │ /phase-4-api ──────────────────► qa-monitor Agent                       ││
│  │ └── imports: phase-4-api.template.md, zero-script-qa.template.md        ││
│  │ └── next-skill: phase-5-design-system                                    ││
│  │                                                                          ││
│  │ /phase-7-seo-security ─────────► code-analyzer Agent                    ││
│  │ └── imports: phase-7-seo-security.template.md                            ││
│  │ └── next-skill: phase-8-review                                           ││
│  │                                                                          ││
│  │ /phase-8-review ───────────────► design-validator Agent (NEW)           ││
│  │ └── imports: phase-8-review.template.md                                  ││
│  │ └── next-skill: phase-9-deployment                                       ││
│  │                                                                          ││
│  │ /phase-9-deployment ───────────► infra-architect Agent                  ││
│  │ └── imports: phase-9-deployment.template.md                              ││
│  │ └── next-skill: null (완료)                                              ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ Specialized Skills Layer                                                 ││
│  │                                                                          ││
│  │ /zero-script-qa ───────────────► qa-monitor Agent                       ││
│  │ └── imports: zero-script-qa.template.md                                  ││
│  │                                                                          ││
│  │ /code-review (NEW) ────────────► code-analyzer Agent (NEW)              ││
│  │ └── imports: phase-8-review.template.md                                  ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ Agents Layer (11개 모두 연결)                                            ││
│  │                                                                          ││
│  │ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐             ││
│  │ │ gap-detector    │ │ pdca-iterator   │ │ report-generator│             ││
│  │ │ (pdca analyze)  │ │ (pdca iterate)  │ │ (pdca report)   │             ││
│  │ │ model: opus     │ │ model: sonnet   │ │ model: haiku    │             ││
│  │ └────────┬────────┘ └────────┬────────┘ └────────┬────────┘             ││
│  │          │ Stop Hook        │ Stop Hook        │                         ││
│  │          ▼                  ▼                  ▼                         ││
│  │  [Match Rate 기반 분기] [재검증 트리거] [아카이브 제안]                  ││
│  │                                                                          ││
│  │ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐             ││
│  │ │ code-analyzer   │ │ design-validator│ │ qa-monitor      │             ││
│  │ │ (code-review)   │ │ (phase-8)       │ │ (phase-4, ZSQ)  │             ││
│  │ │ model: opus     │ │ model: opus     │ │ model: haiku    │             ││
│  │ └─────────────────┘ └─────────────────┘ └─────────────────┘             ││
│  │                                                                          ││
│  │ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐             ││
│  │ │ starter-guide   │ │ bkend-expert    │ │ enterprise-exp  │             ││
│  │ │ (starter)       │ │ (dynamic)       │ │ (enterprise)    │             ││
│  │ │ model: sonnet   │ │ model: sonnet   │ │ model: opus     │             ││
│  │ └─────────────────┘ └─────────────────┘ └─────────────────┘             ││
│  │                                                                          ││
│  │ ┌─────────────────┐ ┌─────────────────┐                                 ││
│  │ │ pipeline-guide  │ │ infra-architect │                                 ││
│  │ │ (pipeline)      │ │ (enterprise, 9) │                                 ││
│  │ │ model: sonnet   │ │ model: opus     │                                 ││
│  │ └─────────────────┘ └─────────────────┘                                 ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ Task Management Integration                                              ││
│  │                                                                          ││
│  │ PDCA Task Chain (자동 생성):                                             ││
│  │                                                                          ││
│  │ [Plan] feature                                                           ││
│  │    ↓ blockedBy                                                           ││
│  │ [Design] feature                                                         ││
│  │    ↓ blockedBy                                                           ││
│  │ [Do] feature                                                             ││
│  │    ↓ blockedBy                                                           ││
│  │ [Check] feature ← gap-detector 결과                                      ││
│  │    ↓ blockedBy (Check < 90%)                                             ││
│  │ [Act-1] feature ← pdca-iterator 실행                                     ││
│  │    ↓ (반복)                                                              ││
│  │ [Act-N] feature                                                          ││
│  │    ↓ (Check ≥ 90%)                                                       ││
│  │ [Report] feature ← report-generator 실행                                 ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 11. Appendix A: Skill 파일 수정 명세

> **Philosophy 준수**: "No Guessing" - Skill frontmatter에 agent 명시적 연결
> **Philosophy 준수**: "Automation First" - action별 Agent 자동 호출

### A.1 pdca/SKILL.md 수정 (HIGH)

**현재 상태**: agent 필드 없음, 본문에서만 Agent 언급

```yaml
# 현재 (skills/pdca/SKILL.md)
---
name: pdca
description: |
  PDCA 사이클 전체를 관리하는 통합 skill...
# agent: 필드 없음 ❌
imports:
  - ${PLUGIN_ROOT}/templates/plan.template.md
  ...
---
```

**개선안**: agents 필드 추가 (action별 Agent 매핑)

```yaml
# 개선 후 (skills/pdca/SKILL.md)
---
name: pdca
# ✅ NEW: action별 Agent 매핑
agents:
  analyze: gap-detector      # Check 단계
  iterate: pdca-iterator     # Act 단계
  report: report-generator   # Report 단계
imports:
  - ${PLUGIN_ROOT}/templates/plan.template.md
  - ${PLUGIN_ROOT}/templates/design.template.md
  - ${PLUGIN_ROOT}/templates/do.template.md
  - ${PLUGIN_ROOT}/templates/analysis.template.md
  - ${PLUGIN_ROOT}/templates/report.template.md
  - ${PLUGIN_ROOT}/templates/iteration-report.template.md  # ✅ 추가
---
```

### A.2 enterprise/SKILL.md 수정 (HIGH)

**현재**: `agent: infra-architect` (enterprise-expert 미연결)

**개선안**:
```yaml
agents:
  init: enterprise-expert     # 초기 전략 수립
  strategy: enterprise-expert # 전략 결정
  infra: infra-architect      # 인프라 설계
```

### A.3 phase-8-review/SKILL.md 수정 (MEDIUM)

**개선안**:
```yaml
agents:
  design: design-validator    # 설계 문서 검증
  code: code-analyzer        # 코드 품질 분석
```

### A.4 신규 code-review/SKILL.md 생성 (MEDIUM)

```yaml
---
name: code-review
description: 코드 품질 및 아키텍처 검토 skill
user-invocable: true
agent: code-analyzer
imports:
  - ${PLUGIN_ROOT}/templates/shared/error-handling-patterns.md
  - ${PLUGIN_ROOT}/templates/shared/naming-conventions.md
---
```

---

## 12. Appendix B: Agent 파일 수정 명세

> **Philosophy 준수**: "Docs = Code" - Agent frontmatter에 Skill 연결 명시

### B.1 gap-detector.md, pdca-iterator.md, report-generator.md

각 Agent에 `linked-from-skills:` 필드 추가:

```yaml
# agents/gap-detector.md
skills:
  - bkit-templates
  - phase-2-convention
  - pdca  # ✅ 추가
linked-from-skills:
  - pdca (analyze action)
```

```yaml
# agents/pdca-iterator.md
linked-from-skills:
  - pdca (iterate action)
```

```yaml
# agents/report-generator.md
skills:
  - bkit-templates
  - pdca  # ✅ 추가
linked-from-skills:
  - pdca (report action)
```

### B.2 enterprise-expert.md, design-validator.md, code-analyzer.md

```yaml
# agents/enterprise-expert.md
linked-from-skills:
  - enterprise (init, strategy actions)

# agents/design-validator.md
skills:
  - bkit-templates
  - phase-8-review  # ✅ 추가
linked-from-skills:
  - phase-8-review (design action)

# agents/code-analyzer.md
skills_preload:
  - phase-2-convention
  - phase-8-review
  - code-review  # ✅ 추가
linked-from-skills:
  - code-review (main agent)
  - phase-8-review (code action)
```

---

## 13. Appendix C: 신규 Template 전체 내용

### C.1 schema.template.md (Phase 1용)

**경로**: `templates/pipeline/schema.template.md` (신규)

```markdown
---
template: schema
version: 1.0
description: Phase 1 Schema/Terminology definition template
---

# {project} Schema & Terminology

## 1. Terminology (용어 정의)

### 1.1 Domain Terms
| 용어 (KO) | Term (EN) | 정의 | 예시 |
|-----------|-----------|------|------|
| 사용자 | User | 시스템에 가입한 계정 보유자 | 이메일로 로그인한 회원 |

### 1.2 Technical Terms
| 용어 | 정의 | 사용 위치 |
|------|------|----------|
| API Client | 서버와 통신하는 클라이언트 모듈 | lib/api/ |

## 2. Data Schema

### 2.1 Core Entities

#### User
| Field | Type | Required | Description | Constraints |
|-------|------|:--------:|-------------|-------------|
| id | string (UUID) | ✅ | 고유 식별자 | Primary Key |
| email | string | ✅ | 이메일 주소 | Unique |
| name | string | ✅ | 사용자 이름 | 2-50 chars |
| createdAt | datetime | ✅ | 생성 일시 | Auto |

### 2.2 Relationships
| From | To | Type | Description |
|------|-----|------|-------------|
| User | {Entity} | 1:N | 사용자는 여러 {Entity}를 가짐 |

## 3. API Response Schema (Level: Dynamic+)

### Success Response
\`\`\`typescript
interface SuccessResponse<T> {
  data: T;
  meta?: { timestamp: string; requestId: string; };
}
\`\`\`

### Error Response
\`\`\`typescript
interface ErrorResponse {
  error: { code: string; message: string; details?: object; };
}
\`\`\`

## 4. Validation Rules
| Field Type | Rule | Example |
|------------|------|---------|
| Email | RFC 5322 format | user@example.com |
| Password | Min 8, 1 upper, 1 number | MyPass123 |
```

### C.2 iteration-report.template.md

**상태**: ✅ 이미 존재 (`templates/iteration-report.template.md`)

---

## 14. Appendix D: 기존 Template 확장 상세

### D.1 do.template.md 체크리스트 확장

**위치**: `templates/do.template.md` Section 5.3 이후에 추가

```markdown
### 5.4 Architecture Checklist (Phase 2 기반)

- [ ] **Layer Structure**
  - [ ] Presentation: components/, pages/, app/
  - [ ] Application: services/, use-cases/
  - [ ] Domain: domain/, entities/, types/
  - [ ] Infrastructure: lib/, api/, repositories/

- [ ] **Dependency Direction**
  - [ ] Presentation → Application (O)
  - [ ] Domain → 외부 의존성 없음 (O)

- [ ] **Import Rules**
  - [ ] Components에서 직접 lib/api/ 임포트 안함

### 5.5 Convention Checklist (Phase 2 기반)

- [ ] **Naming Convention**
  - [ ] Components: PascalCase (UserProfile.tsx)
  - [ ] Functions: camelCase (getUserById)
  - [ ] Constants: UPPER_SNAKE_CASE

- [ ] **Import Order**
  1. External libraries
  2. Internal absolute imports (@/...)
  3. Relative imports
  4. Type imports
  5. Styles

### 5.6 Security Checklist (Phase 7 기반)

- [ ] **Input Validation**
  - [ ] 서버사이드 검증
  - [ ] XSS/SQL Injection 방어

- [ ] **Auth**
  - [ ] 인증 필요 API 미들웨어 적용
  - [ ] 하드코딩된 비밀 없음

### 5.7 API Checklist (Phase 4 기반)

- [ ] **Response Format**
  - [ ] Success: { data, meta? }
  - [ ] Error: { error: { code, message } }
```

---

## 15. Appendix E: Stop Hook 개선 명세

### E.1 gap-detector-stop.js 추가 코드

**위치**: `scripts/gap-detector-stop.js` (line 100 근처)

```javascript
// v1.4.4: Task 자동 생성 (FR-07)
const { autoCreatePdcaTask } = require('../lib/common.js');

if (matchRate < threshold && feature) {
  autoCreatePdcaTask('act', feature, {
    blockedBy: `[Check] ${feature}`,
    metadata: { matchRate, iterationCount: iterCount + 1 }
  });
}

if (matchRate >= threshold && feature) {
  autoCreatePdcaTask('report', feature, {
    blockedBy: `[Check] ${feature}`,
    metadata: { matchRate, completedAt: new Date().toISOString() }
  });
}
```

### E.2 iterator-stop.js 추가 코드

**위치**: `scripts/iterator-stop.js` (line 150 근처)

```javascript
// v1.4.4: 자동 재분석 트리거 (FR-06)
if (status === 'improved' && config.pdca?.autoReAnalyze !== false) {
  response.autoTrigger = {
    agent: 'gap-detector',
    reason: 'Auto re-analyze after iteration'
  };
}
```

### E.3 pdca-skill-stop.js PDCA 전환 로직

```javascript
const PDCA_PHASE_TRANSITIONS = {
  'plan': { next: 'design', skill: '/pdca design' },
  'design': { next: 'do', skill: null },
  'do': { next: 'check', skill: '/pdca analyze' },
  'check': { next: 'act', skill: '/pdca iterate', condition: (ctx) => ctx.matchRate < 90 },
  'check_pass': { next: 'report', skill: '/pdca report' },
  'act': { next: 'check', skill: '/pdca analyze' }
};
```

---

## 16. Appendix F: lib/skill-orchestrator.js 확장

### F.1 agents multi-binding 지원

```javascript
/**
 * Parse agents field (supports single and multi-binding)
 */
function parseAgentsField(frontmatter) {
  const agentsField = frontmatter.agents;
  const agentField = frontmatter.agent;

  if (agentsField && typeof agentsField === 'object') {
    return { ...agentsField, _isMultiBinding: true };
  }
  if (agentField && typeof agentField === 'string') {
    return { default: agentField, _isMultiBinding: false };
  }
  return { default: null, _isMultiBinding: false };
}

/**
 * Get agent for specific action
 */
function getAgentForAction(skillName, action) {
  const config = getSkillConfig(skillName);
  const agents = parseAgentsField(config);
  return agents[action] || agents.default || null;
}

/**
 * Get all agents linked to a skill
 */
function getLinkedAgents(skillName) {
  const config = getSkillConfig(skillName);
  const agents = parseAgentsField(config);
  return Object.values(agents).filter(v => v && !v.startsWith('_'));
}
```

---

## 17. 보완 사항 체크리스트

| 보완 필요 항목 | Appendix | 포함 여부 |
|---------------|----------|:---------:|
| Agent 파일 수정 명세 | B | ✅ |
| 신규 Templates 전체 내용 | C (schema.template.md) | ✅ |
| 기존 Template 확장 상세 | D (do.template.md 4개 체크리스트) | ✅ |
| Stop Hook 스크립트 코드 | E (3개 스크립트 개선 코드) | ✅ |
| Skill 파일 수정 명세 | A (pdca, enterprise, phase-8, code-review) | ✅ |
| skill-orchestrator.js 확장 | F (agents multi-binding) | ✅ |

---

## 18. Next Steps

1. [ ] Design 문서 작성 (`v1.4.4-comprehensive-enhancement.design.md`)
2. [ ] 팀 리뷰 및 승인
3. [ ] 구현 시작 (Phase 1: Core Infrastructure부터)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 0.1 | 2026-01-27 | Initial draft | Claude Opus 4.5 |
| 0.2 | 2026-01-27 | Appendix A-F 추가 (보완 명세) | Claude Opus 4.5 |
