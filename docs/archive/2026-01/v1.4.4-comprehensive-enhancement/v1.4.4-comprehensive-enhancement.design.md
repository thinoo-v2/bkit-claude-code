# v1.4.4 Comprehensive Enhancement Design Document

> **Summary**: Skills, Agents, Hooks, Templates의 유기적 연동 강화 상세 설계
>
> **Project**: bkit Vibecoding Kit
> **Version**: 1.4.4
> **Author**: Claude Opus 4.5
> **Date**: 2026-01-27
> **Status**: Draft
> **Planning Doc**: [v1.4.4-comprehensive-enhancement.plan.md](../01-plan/features/v1.4.4-comprehensive-enhancement.plan.md)

---

## 1. Overview

### 1.1 Design Goals

1. **Skills-Agents 100% 연결**: 11개 Agent 모두 Skills에서 호출 가능
2. **agents multi-binding 지원**: action별 다른 Agent 호출 가능
3. **PDCA 자동 전환**: Phase 완료 시 다음 단계 자동 제안/트리거
4. **Task 자동 생성**: PDCA 각 단계에서 blockedBy 의존성 자동 설정

### 1.2 Design Principles

- **Backward Compatibility**: 기존 단일 `agent:` 필드 완전 호환
- **No Breaking Changes**: 기존 scripts/hooks 동작 유지
- **Incremental Enhancement**: 점진적 기능 추가
- **Platform Parity**: Claude Code와 Gemini CLI 동일 동작

---

## 2. Architecture

### 2.1 Component Diagram (개선 후)

```
┌─────────────────────────────────────────────────────────────────┐
│                        User Request                              │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Skill Layer (Entry Point)                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ /pdca       │  │ /enterprise │  │ /phase-8    │             │
│  │ agents:     │  │ agents:     │  │ agents:     │             │
│  │  analyze:   │  │  init:      │  │  design:    │             │
│  │   gap-det   │  │   ent-exp   │  │   des-val   │             │
│  │  iterate:   │  │  infra:     │  │  code:      │             │
│  │   pdca-it   │  │   infra-ar  │  │   code-an   │             │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │
└─────────┼────────────────┼────────────────┼─────────────────────┘
          │                │                │
          ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────────┐
│                skill-orchestrator.js (Enhanced)                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ parseAgentsField()     - agents/agent 필드 파싱            │ │
│  │ getAgentForAction()    - action별 Agent 결정              │ │
│  │ orchestrateSkillPre()  - Task 생성, imports 로드          │ │
│  │ orchestrateSkillPost() - 다음 단계 제안, PDCA 상태 업데이트│ │
│  └────────────────────────────────────────────────────────────┘ │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Agent Layer                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │gap-detector │  │pdca-iterator│  │report-gen   │             │
│  │ Stop Hook:  │  │ Stop Hook:  │  │ Skills:     │             │
│  │  gap-det-   │  │  iterator-  │  │  bkit-temp  │             │
│  │  stop.js    │  │  stop.js    │  │  pdca       │             │
│  └──────┬──────┘  └──────┬──────┘  └─────────────┘             │
└─────────┼────────────────┼──────────────────────────────────────┘
          │                │
          ▼                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Stop Hooks Layer (Enhanced)                    │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ gap-detector-stop.js (Enhanced)                            │ │
│  │  - Match Rate 기반 분기                                    │ │
│  │  - Task 자동 생성 ([Act-N] / [Report])                     │ │
│  │  - AskUserQuestion 프롬프트 생성                           │ │
│  ├────────────────────────────────────────────────────────────┤ │
│  │ iterator-stop.js (Enhanced)                                │ │
│  │  - 반복 결과 기반 분기                                     │ │
│  │  - 자동 재분석 트리거 (autoTrigger 필드)                   │ │
│  │  - Task 상태 업데이트                                      │ │
│  └────────────────────────────────────────────────────────────┘ │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                    State Management Layer                        │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐    │
│  │.pdca-status.json│  │.bkit-memory   │  │Task System     │    │
│  │ matchRate      │  │ activePdca    │  │ [Plan]→[Design]│    │
│  │ iterationCount │  │ pdcaHistory   │  │ →[Do]→[Check]  │    │
│  │ phase          │  │ sessionCount  │  │ →[Act]→[Report]│    │
│  └────────────────┘  └────────────────┘  └────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 Data Flow (PDCA Cycle)

```
User: "/pdca analyze feature"
        │
        ▼
┌───────────────────┐
│ Skill: pdca       │
│ Action: analyze   │
└────────┬──────────┘
         │ getAgentForAction('pdca', 'analyze')
         ▼
┌───────────────────┐
│ Agent: gap-detector│
│ model: opus       │
└────────┬──────────┘
         │ Design vs Implementation 비교
         ▼
┌───────────────────┐
│ Analysis Result   │
│ matchRate: 85%    │
└────────┬──────────┘
         │ Agent Stop
         ▼
┌───────────────────┐
│ gap-detector-stop │
│ .js               │
└────────┬──────────┘
         │ matchRate < 90%
         ▼
┌───────────────────┐       ┌───────────────────┐
│ Task 자동 생성     │       │ AskUserQuestion   │
│ [Act-1] feature   │       │ "자동 개선할까요?" │
│ blockedBy: [Check]│       │ Options:          │
└───────────────────┘       │  - 자동 개선 (권장)│
                            │  - 수동 수정       │
                            │  - 현재 상태 완료  │
                            └───────────────────┘
```

### 2.3 Dependencies

| Component | Depends On | Purpose |
|-----------|-----------|---------|
| skill-orchestrator.js | lib/common.js | PDCA 상태 관리 함수 |
| gap-detector-stop.js | lib/common.js | Task 생성, 상태 업데이트 |
| iterator-stop.js | lib/common.js | Task 업데이트, Phase 전환 |
| pdca skill | templates/*.md | Template imports |
| agents/*.md | skills | skills_preload, skills 필드 |

---

## 3. 상세 설계: Skills 파일 수정

### 3.1 pdca/SKILL.md 수정 (FR-01)

**현재 상태 분석**:
```yaml
# Line 1-30 of skills/pdca/SKILL.md
---
name: pdca
description: |
  PDCA 사이클 전체를 관리하는 통합 skill...
# agent 필드 없음 ❌
imports:
  - ${PLUGIN_ROOT}/templates/plan.template.md
  - ${PLUGIN_ROOT}/templates/design.template.md
  - ${PLUGIN_ROOT}/templates/do.template.md
  - ${PLUGIN_ROOT}/templates/analysis.template.md
  - ${PLUGIN_ROOT}/templates/report.template.md
next-skill: null
pdca-phase: null
task-template: "[PDCA] {feature}"
hooks:
  Stop:
    - matcher: ".*"
      hooks:
        - type: command
          command: "node ${CLAUDE_PLUGIN_ROOT}/scripts/pdca-skill-stop.js"
---
```

**수정 설계**:

```yaml
---
name: pdca
description: |
  PDCA 사이클 전체를 관리하는 통합 skill.
  "계획", "설계", "분석", "보고서", "상태" 키워드로 자동 호출.
  ...

# ✅ NEW: agents multi-binding (action → agent 매핑)
agents:
  analyze: gap-detector      # /pdca analyze → gap-detector Agent
  iterate: pdca-iterator     # /pdca iterate → pdca-iterator Agent
  report: report-generator   # /pdca report → report-generator Agent

imports:
  - ${PLUGIN_ROOT}/templates/plan.template.md
  - ${PLUGIN_ROOT}/templates/design.template.md
  - ${PLUGIN_ROOT}/templates/do.template.md
  - ${PLUGIN_ROOT}/templates/analysis.template.md
  - ${PLUGIN_ROOT}/templates/report.template.md
  - ${PLUGIN_ROOT}/templates/iteration-report.template.md  # ✅ 추가

next-skill: null
pdca-phase: null
task-template: "[PDCA] {feature}"

hooks:
  Stop:
    - matcher: ".*"
      hooks:
        - type: command
          command: "node ${CLAUDE_PLUGIN_ROOT}/scripts/pdca-skill-stop.js"
---
```

**변경 사항**:
- `agents:` 필드 추가 (3개 action-agent 매핑)
- `imports:` 에 iteration-report.template.md 추가

### 3.2 enterprise/SKILL.md 수정 (FR-02)

**현재 상태** (line 17):
```yaml
agent: infra-architect  # enterprise-expert 누락
```

**수정 설계**:
```yaml
# ✅ agents multi-binding
agents:
  init: enterprise-expert     # /enterprise init → enterprise-expert
  strategy: enterprise-expert # /enterprise strategy → enterprise-expert
  infra: infra-architect      # /enterprise infra → infra-architect
  default: enterprise-expert  # 기본 Agent
```

### 3.3 phase-8-review/SKILL.md 수정 (FR-03)

**현재 상태** (line 17):
```yaml
agent: code-analyzer
```

**수정 설계**:
```yaml
# ✅ agents multi-binding
agents:
  design: design-validator    # 설계 문서 검증
  code: code-analyzer        # 코드 품질 분석
  default: code-analyzer     # 기본 Agent
```

### 3.4 신규 code-review/SKILL.md 생성 (FR-04)

**경로**: `skills/code-review/SKILL.md`

```yaml
---
name: code-review
description: |
  코드 품질 및 아키텍처 검토 skill.
  코드 분석, 품질 검사, 보안 스캔 요청 시 자동 호출.

  Triggers: code review, quality check, security scan, code analysis,
  코드 리뷰, 품질 검사, 보안 스캔,
  コードレビュー, 品質チェック,
  代码审查, 质量检查

  Do NOT use for: design document review, gap analysis, writing code.
argument-hint: "[path|feature]"
agent: code-analyzer
allowed-tools:
  - Read
  - Glob
  - Grep
  - Task
  - LSP
user-invocable: true
imports:
  - ${PLUGIN_ROOT}/templates/shared/error-handling-patterns.md
  - ${PLUGIN_ROOT}/templates/shared/naming-conventions.md
next-skill: null
pdca-phase: check
task-template: "[Code-Review] {feature}"
---

# Code Review Skill

## Actions

| Action | Description | Example |
|--------|-------------|---------|
| `[path]` | 특정 경로 코드 리뷰 | `/code-review src/features/` |
| `[feature]` | 기능 전체 코드 리뷰 | `/code-review user-auth` |

## 분석 항목

1. **코드 품질** - 명명 규칙, 코드 구조, 주석
2. **보안** - OWASP Top 10, 비밀정보 검사
3. **아키텍처** - Clean Architecture 준수
4. **중복** - DRY 원칙 위반 검사
5. **확장성** - 하드코딩, 확장성 안티패턴

## Agent 연동

`code-analyzer` Agent가 자동 호출되어 상세 분석을 수행합니다.

## 출력

분석 결과는 콘솔에 표시되며, 상세 보고서는 요청 시 생성됩니다.
```

---

## 4. 상세 설계: Agents 파일 수정

### 4.1 gap-detector.md 수정

**수정 위치**: frontmatter 하단 (line 40 이후)

**추가 내용**:
```yaml
skills:
  - bkit-templates
  - phase-2-convention
  - pdca  # ✅ 추가: pdca skill과 연동

# ✅ NEW: Skill에서 호출되는 정보 문서화
linked-from-skills:
  - pdca (analyze action)
```

### 4.2 pdca-iterator.md 수정

**수정 위치**: frontmatter (line 28 이후)

**추가 내용**:
```yaml
skills_preload:
  - pdca       # ✅ 추가
  - bkit-rules

# ✅ NEW: Skill 연동 문서화
linked-from-skills:
  - pdca (iterate action)
```

### 4.3 report-generator.md 수정

**수정 위치**: frontmatter (line 29 이후)

**추가 내용**:
```yaml
skills:
  - bkit-templates
  - pdca  # ✅ 추가

# ✅ NEW: Skill 연동 문서화
linked-from-skills:
  - pdca (report action)
```

### 4.4 code-analyzer.md 수정

**수정 위치**: frontmatter (line 22 이후)

**수정 내용**:
```yaml
skills_preload:
  - phase-2-convention
  - phase-8-review
  - code-review  # ✅ 추가: 신규 skill 연동

# ✅ NEW: Skill 연동 문서화
linked-from-skills:
  - code-review (main agent)
  - phase-8-review (code action)
```

### 4.5 design-validator.md 수정

**수정 위치**: frontmatter (line 36 이후)

**추가 내용**:
```yaml
skills:
  - bkit-templates
  - phase-8-review  # ✅ 추가

# ✅ NEW: Skill 연동 문서화
linked-from-skills:
  - phase-8-review (design action)
```

### 4.6 enterprise-expert.md 수정

**추가 내용**:
```yaml
# ✅ NEW: Skill 연동 문서화
linked-from-skills:
  - enterprise (init, strategy actions)
```

---

## 5. 상세 설계: lib/skill-orchestrator.js 확장 (FR-05)

### 5.1 현재 상태 분석

```javascript
// Line 164-178: 현재 config 객체
const config = {
  name: frontmatter.name || skillName,
  description: frontmatter.description || '',
  imports: frontmatter.imports || [],
  agent: frontmatter.agent || null,  // ❌ 단일 agent만 지원
  'allowed-tools': frontmatter['allowed-tools'] || [],
  'user-invocable': frontmatter['user-invocable'] || false,
  'argument-hint': frontmatter['argument-hint'] || null,
  'next-skill': frontmatter['next-skill'] || null,
  'pdca-phase': frontmatter['pdca-phase'] || null,
  'task-template': frontmatter['task-template'] || null,
  'skills_preload': frontmatter['skills_preload'] || [],
  hooks: frontmatter.hooks || {},
  body
};
```

### 5.2 수정 설계

**파일**: `lib/skill-orchestrator.js`

**새로운 함수 추가** (line 120 근처):

```javascript
/**
 * Parse agents field (supports single value and multi-binding)
 *
 * Supports:
 * - agent: "single-agent"  → { default: "single-agent" }
 * - agents:
 *     action1: agent1
 *     action2: agent2
 *     default: agentX
 *
 * @param {Object} frontmatter - Parsed frontmatter
 * @returns {Object} agents mapping { action: agentName, _isMultiBinding: boolean }
 */
function parseAgentsField(frontmatter) {
  const agentsField = frontmatter.agents;
  const agentField = frontmatter.agent;

  // Multi-binding: agents: { action: agent }
  if (agentsField && typeof agentsField === 'object') {
    return {
      ...agentsField,
      _isMultiBinding: true
    };
  }

  // Single binding: agent: "agentName"
  if (agentField && typeof agentField === 'string') {
    return {
      default: agentField,
      _isMultiBinding: false
    };
  }

  // No agent defined
  return {
    default: null,
    _isMultiBinding: false
  };
}

/**
 * Get agent name for specific action
 *
 * @param {string} skillName - Skill name
 * @param {string} action - Action name (e.g., 'analyze', 'iterate')
 * @returns {string|null} Agent name or null
 */
function getAgentForAction(skillName, action) {
  const config = getSkillConfig(skillName);
  if (!config) return null;

  const agents = parseAgentsField(config);

  // Try action-specific agent first, then default
  return agents[action] || agents.default || null;
}

/**
 * Get all agents linked to a skill
 *
 * @param {string} skillName - Skill name
 * @returns {string[]} Array of agent names
 */
function getLinkedAgents(skillName) {
  const config = getSkillConfig(skillName);
  if (!config) return [];

  const agents = parseAgentsField(config);

  return Object.entries(agents)
    .filter(([key, value]) => key !== '_isMultiBinding' && value)
    .map(([_, value]) => value);
}

/**
 * Check if skill uses multi-binding
 *
 * @param {string} skillName - Skill name
 * @returns {boolean} True if multi-binding
 */
function isMultiBindingSkill(skillName) {
  const config = getSkillConfig(skillName);
  if (!config) return false;

  const agents = parseAgentsField(config);
  return agents._isMultiBinding === true;
}
```

**getSkillConfig 수정** (line 164 근처):

```javascript
const config = {
  name: frontmatter.name || skillName,
  description: frontmatter.description || '',
  imports: frontmatter.imports || [],
  // ✅ 기존 호환성 유지
  agent: frontmatter.agent || null,
  // ✅ NEW: agents 필드 추가
  agents: frontmatter.agents || null,
  'allowed-tools': frontmatter['allowed-tools'] || [],
  'user-invocable': frontmatter['user-invocable'] || false,
  'argument-hint': frontmatter['argument-hint'] || null,
  'next-skill': frontmatter['next-skill'] || null,
  'pdca-phase': frontmatter['pdca-phase'] || null,
  'task-template': frontmatter['task-template'] || null,
  'skills_preload': frontmatter['skills_preload'] || [],
  // ✅ NEW: Skill 연동 문서화
  'linked-from-skills': frontmatter['linked-from-skills'] || null,
  hooks: frontmatter.hooks || {},
  body
};
```

**parseSkillFrontmatter 확장** (line 80 근처):

```javascript
// Parse agents object (multi-binding)
const agentsMatch = yamlStr.match(/agents:\s*\n((?:\s+\w+:\s+\w[\w-]*\n?)+)/);
if (agentsMatch) {
  const agentsBlock = agentsMatch[1];
  const agentsObj = {};

  const agentLines = agentsBlock.split('\n')
    .map(line => line.trim())
    .filter(line => line && line.includes(':'));

  for (const line of agentLines) {
    const [key, value] = line.split(':').map(s => s.trim());
    if (key && value) {
      agentsObj[key] = value;
    }
  }

  frontmatter.agents = agentsObj;
}
```

**모듈 exports 확장** (line 357 근처):

```javascript
module.exports = {
  parseSkillFrontmatter,
  getSkillConfig,
  orchestrateSkillPre,
  orchestrateSkillPost,
  getNextStepMessage,
  clearCache,
  getCacheStats,
  SKILL_CACHE_TTL,
  // ✅ NEW: agents multi-binding 지원 함수
  parseAgentsField,
  getAgentForAction,
  getLinkedAgents,
  isMultiBindingSkill
};
```

---

## 6. 상세 설계: Stop Hooks 개선 (FR-06, FR-07)

### 6.1 gap-detector-stop.js 개선

**파일**: `scripts/gap-detector-stop.js`

**추가 import** (line 26 근처):

```javascript
const {
  readStdinSync,
  outputAllow,
  generateTaskGuidance,
  debugLog,
  updatePdcaStatus,
  extractFeatureFromContext,
  getPdcaStatusFull,
  emitUserPrompt,
  getBkitConfig,
  isGeminiCli,
  autoAdvancePdcaPhase,
  extractRequirementsFromPlan,
  calculateRequirementFulfillment,
  // ✅ NEW: Task 자동 생성
  autoCreatePdcaTask,       // FR-07
  updatePdcaTaskStatus      // FR-07
} = require('../lib/common.js');
```

**Task 자동 생성 로직 추가** (line 100 근처, userPrompt 생성 전):

```javascript
// ============================================
// v1.4.4: Task 자동 생성 (FR-07)
// ============================================

if (feature) {
  // Check Task 상태 업데이트
  updatePdcaTaskStatus('check', feature, {
    matchRate,
    status: matchRate >= threshold ? 'completed' : 'in_progress'
  });

  if (matchRate < threshold) {
    // Act Task 자동 생성 (matchRate < 90%)
    autoCreatePdcaTask('act', feature, {
      subject: `[Act-${iterCount + 1}] ${feature}`,
      description: `Gap Analysis ${matchRate}% - 자동 개선 필요\n\n목표: ${threshold}% 이상 달성`,
      blockedBy: [`[Check] ${feature}`],
      metadata: {
        pdcaPhase: 'act',
        matchRate,
        iterationNumber: iterCount + 1,
        maxIterations
      }
    });

    debugLog('Agent:gap-detector:Stop', 'Act task created', {
      feature,
      matchRate,
      iteration: iterCount + 1
    });
  } else {
    // Report Task 자동 생성 (matchRate >= 90%)
    autoCreatePdcaTask('report', feature, {
      subject: `[Report] ${feature}`,
      description: `Gap Analysis ${matchRate}% 달성 - 완료 보고서 생성 가능`,
      blockedBy: [`[Check] ${feature}`],
      metadata: {
        pdcaPhase: 'report',
        matchRate,
        completedAt: new Date().toISOString()
      }
    });

    debugLog('Agent:gap-detector:Stop', 'Report task created', {
      feature,
      matchRate
    });
  }
}
```

### 6.2 iterator-stop.js 개선

**파일**: `scripts/iterator-stop.js`

**자동 재분석 트리거 로직 추가** (line 150 근처):

```javascript
// ============================================
// v1.4.4: 자동 재분석 트리거 (FR-06)
// ============================================

// 설정에서 autoReAnalyze 확인 (기본값: true)
const autoReAnalyze = config.pdca?.autoReAnalyze !== false;

if (status === 'improved' && autoReAnalyze && matchRate < threshold) {
  // 자동 재분석 트리거 정보 추가
  response.autoTrigger = {
    agent: 'gap-detector',
    skill: '/pdca analyze',
    feature: feature,
    reason: `Auto re-analyze after iteration (current: ${matchRate}%, target: ${threshold}%)`,
    delay: 0  // 즉시 실행
  };

  debugLog('Agent:pdca-iterator:Stop', 'Auto re-analyze triggered', {
    feature,
    matchRate,
    iteration: currentIteration
  });
}

// Task 상태 업데이트
if (feature) {
  updatePdcaTaskStatus('act', feature, {
    iteration: currentIteration,
    matchRate,
    status: status === 'completed' ? 'completed' : 'in_progress'
  });
}
```

### 6.3 pdca-skill-stop.js PDCA 전환 로직 확장

**파일**: `scripts/pdca-skill-stop.js`

**PDCA 전환 맵 추가** (line 30 근처):

```javascript
/**
 * PDCA Phase 전환 맵 (v1.4.4)
 *
 * 각 Phase 완료 시 다음 단계로 자동 전환
 */
const PDCA_PHASE_TRANSITIONS = {
  'plan': {
    next: 'design',
    skill: '/pdca design',
    message: 'Plan 완료. Design 단계로 진행하세요.',
    taskTemplate: '[Design] {feature}'
  },
  'design': {
    next: 'do',
    skill: null,  // 구현은 수동
    message: 'Design 완료. 구현을 시작하세요.',
    taskTemplate: '[Do] {feature}'
  },
  'do': {
    next: 'check',
    skill: '/pdca analyze',
    message: '구현 완료. Gap 분석을 실행하세요.',
    taskTemplate: '[Check] {feature}'
  },
  'check': {
    // 조건부 전환
    conditions: [
      {
        when: (ctx) => ctx.matchRate >= 90,
        next: 'report',
        skill: '/pdca report',
        message: 'Check 통과! 완료 보고서를 생성하세요.',
        taskTemplate: '[Report] {feature}'
      },
      {
        when: (ctx) => ctx.matchRate < 90,
        next: 'act',
        skill: '/pdca iterate',
        message: 'Check 미달. 자동 개선을 실행하세요.',
        taskTemplate: '[Act-{N}] {feature}'
      }
    ]
  },
  'act': {
    next: 'check',
    skill: '/pdca analyze',
    message: 'Act 완료. 재검증을 실행하세요.',
    taskTemplate: '[Check] {feature}'
  }
};

/**
 * PDCA 전환 결정
 * @param {string} currentPhase - 현재 Phase
 * @param {Object} context - { matchRate, iterationCount, feature }
 * @returns {Object} { next, skill, message, taskTemplate }
 */
function determinePdcaTransition(currentPhase, context) {
  const transition = PDCA_PHASE_TRANSITIONS[currentPhase];
  if (!transition) return null;

  // 조건부 전환 처리
  if (transition.conditions) {
    for (const condition of transition.conditions) {
      if (condition.when(context)) {
        return {
          next: condition.next,
          skill: condition.skill,
          message: condition.message,
          taskTemplate: condition.taskTemplate.replace('{N}', context.iterationCount || 1)
        };
      }
    }
    return null;
  }

  // 일반 전환
  return {
    next: transition.next,
    skill: transition.skill,
    message: transition.message,
    taskTemplate: transition.taskTemplate
  };
}
```

---

## 7. 상세 설계: lib/common.js 확장 (FR-07, FR-11)

### 7.1 Task 자동 생성 함수 추가

**파일**: `lib/common.js`

```javascript
/**
 * PDCA Task 자동 생성 (v1.4.4 - FR-07)
 *
 * @param {string} phase - PDCA phase ('plan', 'design', 'do', 'check', 'act', 'report')
 * @param {string} feature - Feature name
 * @param {Object} options - Task 옵션
 * @returns {Object|null} 생성된 Task 정보 또는 null
 */
function autoCreatePdcaTask(phase, feature, options = {}) {
  const {
    subject = `[${capitalize(phase)}] ${feature}`,
    description = `PDCA ${phase} phase for ${feature}`,
    blockedBy = [],
    metadata = {}
  } = options;

  // Task System 호출 (Claude Code용)
  if (!isGeminiCli()) {
    // stdout으로 Task 생성 요청 출력
    const taskRequest = {
      type: 'task_create',
      task: {
        subject,
        description,
        activeForm: `${subject} 진행 중`,
        blockedBy,
        metadata: {
          pdcaPhase: phase,
          feature,
          ...metadata
        }
      }
    };

    debugLog('Common', 'Task create request', taskRequest);
    return taskRequest;
  }

  // Gemini CLI: 파일 기반 상태 관리
  const status = getPdcaStatusFull();
  if (!status.features) status.features = {};
  if (!status.features[feature]) status.features[feature] = {};
  if (!status.features[feature].tasks) status.features[feature].tasks = {};

  status.features[feature].tasks[phase] = {
    subject,
    description,
    blockedBy,
    createdAt: new Date().toISOString(),
    status: 'pending',
    metadata
  };

  savePdcaStatus(status);
  return status.features[feature].tasks[phase];
}

/**
 * PDCA Task 상태 업데이트 (v1.4.4 - FR-07)
 *
 * @param {string} phase - PDCA phase
 * @param {string} feature - Feature name
 * @param {Object} updates - 업데이트 내용
 */
function updatePdcaTaskStatus(phase, feature, updates = {}) {
  const status = getPdcaStatusFull();

  if (!status.features?.[feature]?.tasks?.[phase]) {
    debugLog('Common', 'Task not found for update', { phase, feature });
    return null;
  }

  Object.assign(status.features[feature].tasks[phase], {
    ...updates,
    updatedAt: new Date().toISOString()
  });

  savePdcaStatus(status);
  return status.features[feature].tasks[phase];
}

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}
```

### 7.2 Level별 Phase Skip 로직 (FR-11)

```javascript
/**
 * Level별 적용 Phase 맵 (v1.4.4 - FR-11)
 *
 * Starter: Phase 4, 5, 7, 8 skip
 * Dynamic: Phase 8 optional
 * Enterprise: 모든 Phase 적용
 */
const LEVEL_PHASE_MAP = {
  'starter': [1, 2, 3, 6, 9],
  'dynamic': [1, 2, 3, 4, 5, 6, 7, 9],  // Phase 8 optional
  'enterprise': [1, 2, 3, 4, 5, 6, 7, 8, 9]
};

/**
 * Level에 따른 다음 Phase 결정
 *
 * @param {number} currentPhase - 현재 Phase 번호
 * @param {string} level - Project level ('starter', 'dynamic', 'enterprise')
 * @returns {number|null} 다음 Phase 번호 또는 null (완료)
 */
function getNextPhaseForLevel(currentPhase, level) {
  const normalizedLevel = (level || 'dynamic').toLowerCase();
  const phases = LEVEL_PHASE_MAP[normalizedLevel] || LEVEL_PHASE_MAP.dynamic;

  const currentIndex = phases.indexOf(currentPhase);

  if (currentIndex === -1) {
    // 현재 Phase가 해당 Level에 없으면 다음 가능한 Phase 찾기
    const nextPhases = phases.filter(p => p > currentPhase);
    return nextPhases.length > 0 ? nextPhases[0] : null;
  }

  if (currentIndex < phases.length - 1) {
    return phases[currentIndex + 1];
  }

  return null;  // 완료
}

/**
 * Level에서 Phase가 적용되는지 확인
 *
 * @param {number} phase - Phase 번호
 * @param {string} level - Project level
 * @returns {boolean}
 */
function isPhaseApplicable(phase, level) {
  const normalizedLevel = (level || 'dynamic').toLowerCase();
  const phases = LEVEL_PHASE_MAP[normalizedLevel] || LEVEL_PHASE_MAP.dynamic;
  return phases.includes(phase);
}

/**
 * Level별 Phase 가이드 메시지 생성
 *
 * @param {string} level - Project level
 * @returns {string} 가이드 메시지
 */
function getLevelPhaseGuide(level) {
  const normalizedLevel = (level || 'dynamic').toLowerCase();
  const phases = LEVEL_PHASE_MAP[normalizedLevel];

  const phaseNames = {
    1: 'Schema',
    2: 'Convention',
    3: 'Mockup',
    4: 'API',
    5: 'Design System',
    6: 'UI Implementation',
    7: 'SEO/Security',
    8: 'Review',
    9: 'Deployment'
  };

  const activePhases = phases.map(p => `Phase ${p}: ${phaseNames[p]}`);

  return `${normalizedLevel.charAt(0).toUpperCase() + normalizedLevel.slice(1)} Level Pipeline:\n${activePhases.join(' → ')}`;
}
```

---

## 8. 상세 설계: Templates 확장

### 8.1 schema.template.md 신규 생성 (FR-10)

**경로**: `templates/pipeline/schema.template.md`

**내용**: Plan 문서 Appendix C.1 참조 (이미 정의됨)

### 8.2 do.template.md 체크리스트 확장 (FR-09)

**파일**: `templates/do.template.md`

**추가 위치**: Section 5.3 이후

**추가 내용**: Plan 문서 Appendix D.1 참조 (이미 정의됨)

- Section 5.4: Architecture Checklist
- Section 5.5: Convention Checklist
- Section 5.6: Security Checklist
- Section 5.7: API Checklist

---

## 9. Implementation Order (구현 순서)

### Phase 1: Core Infrastructure (HIGH Priority)

| 순서 | Task | 파일 | 예상 변경량 |
|:----:|------|------|:----------:|
| 1.1 | parseAgentsField 함수 추가 | lib/skill-orchestrator.js | +60 lines |
| 1.2 | getAgentForAction 함수 추가 | lib/skill-orchestrator.js | +20 lines |
| 1.3 | getSkillConfig 수정 | lib/skill-orchestrator.js | +10 lines |
| 1.4 | parseSkillFrontmatter 확장 | lib/skill-orchestrator.js | +20 lines |

### Phase 2: Skills 파일 수정 (HIGH Priority)

| 순서 | Task | 파일 | 예상 변경량 |
|:----:|------|------|:----------:|
| 2.1 | pdca skill agents 추가 | skills/pdca/SKILL.md | +10 lines |
| 2.2 | enterprise skill agents 추가 | skills/enterprise/SKILL.md | +8 lines |
| 2.3 | phase-8-review skill agents 추가 | skills/phase-8-review/SKILL.md | +8 lines |
| 2.4 | code-review skill 생성 | skills/code-review/SKILL.md | +60 lines (신규) |

### Phase 3: Agents 파일 수정 (MEDIUM Priority)

| 순서 | Task | 파일 | 예상 변경량 |
|:----:|------|------|:----------:|
| 3.1 | gap-detector 수정 | agents/gap-detector.md | +5 lines |
| 3.2 | pdca-iterator 수정 | agents/pdca-iterator.md | +5 lines |
| 3.3 | report-generator 수정 | agents/report-generator.md | +5 lines |
| 3.4 | code-analyzer 수정 | agents/code-analyzer.md | +5 lines |
| 3.5 | design-validator 수정 | agents/design-validator.md | +5 lines |

### Phase 4: Stop Hooks 개선 (HIGH Priority)

| 순서 | Task | 파일 | 예상 변경량 |
|:----:|------|------|:----------:|
| 4.1 | Task 자동 생성 함수 추가 | lib/common.js | +80 lines |
| 4.2 | gap-detector-stop.js 개선 | scripts/gap-detector-stop.js | +40 lines |
| 4.3 | iterator-stop.js 개선 | scripts/iterator-stop.js | +30 lines |
| 4.4 | pdca-skill-stop.js 전환 로직 | scripts/pdca-skill-stop.js | +60 lines |

### Phase 5: lib/common.js 확장 (MEDIUM Priority)

| 순서 | Task | 파일 | 예상 변경량 |
|:----:|------|------|:----------:|
| 5.1 | Level Phase Map 추가 | lib/common.js | +40 lines |
| 5.2 | getNextPhaseForLevel 함수 | lib/common.js | +20 lines |
| 5.3 | isPhaseApplicable 함수 | lib/common.js | +10 lines |

### Phase 6: Templates 보완 (LOW Priority)

| 순서 | Task | 파일 | 예상 변경량 |
|:----:|------|------|:----------:|
| 6.1 | schema.template.md 생성 | templates/pipeline/schema.template.md | +100 lines (신규) |
| 6.2 | do.template.md 확장 | templates/do.template.md | +50 lines |

### Phase 7: Cleanup (LOW Priority)

| 순서 | Task | 파일 | 예상 변경량 |
|:----:|------|------|:----------:|
| 7.1 | commands/backup/ 삭제 | commands/backup/ | 삭제 |

---

## 10. Test Plan

### 10.1 Unit Tests

| 테스트 대상 | 테스트 케이스 | 예상 결과 |
|------------|--------------|----------|
| parseAgentsField() | agents: { a: b } | { a: 'b', _isMultiBinding: true } |
| parseAgentsField() | agent: "single" | { default: 'single', _isMultiBinding: false } |
| parseAgentsField() | 둘 다 없음 | { default: null, _isMultiBinding: false } |
| getAgentForAction('pdca', 'analyze') | agents 정의됨 | 'gap-detector' |
| getAgentForAction('pdca', 'unknown') | default 있음 | default agent |
| getNextPhaseForLevel(3, 'starter') | Starter 레벨 | 6 (Phase 4,5 skip) |
| isPhaseApplicable(4, 'starter') | Starter 레벨 | false |

### 10.2 Integration Tests

| 시나리오 | 테스트 방법 | 성공 기준 |
|----------|-----------|----------|
| /pdca analyze 실행 | gap-detector Agent 호출 확인 | Agent 정상 실행 |
| /pdca iterate 실행 | pdca-iterator Agent 호출 확인 | Agent 정상 실행 |
| /enterprise init 실행 | enterprise-expert Agent 호출 확인 | Agent 정상 실행 |
| gap-detector 완료 | Task 자동 생성 확인 | [Act-1] 또는 [Report] Task 생성 |
| Starter 레벨 Phase 진행 | Phase 4 skip 확인 | Phase 3 → Phase 6 전환 |

### 10.3 Regression Tests

| 기존 기능 | 테스트 방법 | 성공 기준 |
|----------|-----------|----------|
| 단일 agent: 필드 | /starter 실행 | starter-guide Agent 정상 호출 |
| Hook 동작 | PreToolUse(Write) | pre-write.js 정상 실행 |
| PDCA 상태 관리 | .pdca-status.json 업데이트 | 정상 저장/로드 |
| Gemini CLI 호환 | Gemini에서 /pdca 실행 | 정상 동작 |

---

## 11. Quality Criteria

### 11.1 Code Quality

- [ ] ESLint 에러 없음
- [ ] JSDoc 주석 추가 (새 함수 모두)
- [ ] debugLog 호출 포함 (디버깅용)
- [ ] Error handling 완비

### 11.2 Documentation

- [ ] SKILL.md에 agents 필드 문서화
- [ ] README 업데이트 (새 기능 설명)
- [ ] CHANGELOG 업데이트

### 11.3 Backward Compatibility

- [ ] 기존 단일 agent: 필드 완전 호환
- [ ] 기존 hooks 동작 유지
- [ ] Gemini CLI 호환성 유지

---

## 12. Risk Mitigation

| Risk | Impact | Mitigation |
|------|--------|------------|
| agents 파싱 실패 | HIGH | fallback to agent: 필드 |
| Task 생성 실패 | MEDIUM | 수동 생성 안내 메시지 |
| Stop Hook 무한 루프 | HIGH | maxIterations 체크 강화 |
| Gemini hooks 차이 | LOW | isGeminiCli() 분기 처리 |

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 0.1 | 2026-01-27 | Initial design draft | Claude Opus 4.5 |
