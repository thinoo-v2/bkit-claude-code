# v1.4.4 Script Path Fix - Plan Document

> **Summary**: Skills/Agents hooks에서 ${CLAUDE_PLUGIN_ROOT} 경로 해석 오류 수정
>
> **Project**: bkit Vibecoding Kit
> **Version**: 1.4.4-hotfix
> **Author**: Claude Opus 4.5
> **Date**: 2026-01-27
> **Status**: Planning
> **Priority**: CRITICAL

---

## 1. Problem Statement

### 1.1 에러 현상

```
Error: Cannot find module '/Users/popup-kay/Documents/GitHub/popup/bkit-claude-code/.claude/skills/pdca/scripts/pdca-skill-stop.js'
```

### 1.2 원인 분석

Skills/Agents의 hooks에서 `${CLAUDE_PLUGIN_ROOT}` 변수가 **skill 디렉토리**로 해석됨:

```
기대 경로: /Users/popup-kay/Documents/GitHub/popup/bkit-claude-code/scripts/pdca-skill-stop.js
실제 경로: /Users/popup-kay/Documents/GitHub/popup/bkit-claude-code/.claude/skills/pdca/scripts/pdca-skill-stop.js
```

### 1.3 영향 범위

| 카테고리 | 파일 수 | 영향받는 스크립트 참조 |
|---------|:-------:|:---------------------:|
| Skills | 10 | 15 |
| Agents | 5 | 9 |
| **Total** | **15** | **24** |

---

## 2. Root Cause Analysis

### 2.1 변수 해석 차이

| 변수 | hooks/hooks.json | skills/*.md | agents/*.md |
|------|------------------|-------------|-------------|
| `${CLAUDE_PLUGIN_ROOT}` | Plugin root (정상) | Skill directory (오류) | Agent directory (오류) |

### 2.2 Claude Code Plugin 동작

```
Plugin 로드 시:
1. hooks/hooks.json → CLAUDE_PLUGIN_ROOT = /path/to/bkit-claude-code/
2. skills/pdca/SKILL.md → CLAUDE_PLUGIN_ROOT = .claude/skills/pdca/ (문제!)
3. agents/gap-detector.md → CLAUDE_PLUGIN_ROOT = agents/ 또는 유사 경로 (문제!)
```

---

## 3. Affected Files Analysis

### 3.1 Skills 파일 (10개, 15 참조)

| Skill | 스크립트 참조 | 존재 여부 |
|-------|-------------|:--------:|
| `skills/pdca/SKILL.md` | pdca-skill-stop.js | ✅ |
| `skills/bkit-rules/SKILL.md` | pre-write.js, pdca-post-write.js | ✅ |
| `skills/phase-8-review/SKILL.md` | phase8-review-stop.js | ✅ |
| `skills/zero-script-qa/SKILL.md` | qa-pre-bash.js, qa-stop.js | ✅ |
| `skills/claude-code-learning/SKILL.md` | learning-stop.js | ✅ |
| `skills/phase-4-api/SKILL.md` | phase4-api-stop.js | ✅ |
| `skills/code-review/SKILL.md` | code-review-stop.js | ✅ |
| `skills/phase-6-ui-integration/SKILL.md` | phase6-ui-post.js, phase6-ui-stop.js | ✅ |
| `skills/phase-9-deployment/SKILL.md` | phase9-deploy-pre.js, phase9-deploy-stop.js | ✅ |
| `skills/phase-5-design-system/SKILL.md` | phase5-design-post.js, phase5-design-stop.js | ✅ |

### 3.2 Agents 파일 (5개, 9 참조)

| Agent | 스크립트 참조 | 존재 여부 |
|-------|-------------|:--------:|
| `agents/gap-detector.md` | gap-detector-stop.js | ✅ |
| `agents/pdca-iterator.md` | iterator-stop.js | ✅ |
| `agents/code-analyzer.md` | code-analyzer-pre.js, analysis-stop.js | ✅ |
| `agents/qa-monitor.md` | qa-pre-bash.js, qa-monitor-post.js, qa-stop.js | ✅ |
| `agents/design-validator.md` | design-validator-pre.js | ✅ |

**참고**: 모든 스크립트가 `scripts/` 디렉토리에 존재함. 경로 해석 문제만 수정 필요.

---

## 4. Solution Options

### 4.1 Option A: 상대 경로 + 환경 변수 (권장)

**변경 전**:
```yaml
command: "node ${CLAUDE_PLUGIN_ROOT}/scripts/pdca-skill-stop.js"
```

**변경 후**:
```yaml
command: "node ${PLUGIN_ROOT}/scripts/pdca-skill-stop.js"
```

- `${PLUGIN_ROOT}` = bkit-claude-code root directory
- Skills/Agents/Hooks 모두에서 일관된 동작

**장점**:
- 간단한 변경
- 향후 호환성 유지

**단점**:
- Claude Code가 `${PLUGIN_ROOT}` 지원하는지 확인 필요

### 4.2 Option B: 심볼릭 링크 생성

각 skill/agent 디렉토리에 scripts 심볼릭 링크 생성:

```bash
ln -s ../../../scripts skills/pdca/scripts
ln -s ../../scripts agents/scripts
```

**장점**:
- 기존 경로 변수 유지

**단점**:
- Windows 호환성 문제
- 유지보수 복잡

### 4.3 Option C: 절대 경로 사용 (비권장)

```yaml
command: "node /path/to/bkit-claude-code/scripts/pdca-skill-stop.js"
```

**장점**:
- 확실한 해결

**단점**:
- 이식성 없음
- 하드코딩

### 4.4 Option D: hooks.json에 통합 (현재 권장)

Skills/Agents의 hooks를 제거하고 `hooks/hooks.json`에 모든 hooks 정의:

**장점**:
- 중앙 집중 관리
- `${CLAUDE_PLUGIN_ROOT}` 정상 동작

**단점**:
- Skills/Agents 파일의 hooks 구조 변경 필요
- Agent-specific hooks 매칭 복잡

---

## 5. Recommended Solution

### 5.1 선택: Option D + A 하이브리드

1. **Agents의 hooks** → `hooks/hooks.json`으로 이동 (Option D)
2. **Skills의 hooks** → `${PLUGIN_ROOT}` 변수 사용 테스트 후 결정 (Option A)

### 5.2 구현 순서

| Phase | Task | 파일 수 | 예상 변경량 |
|:-----:|------|:------:|:----------:|
| 1 | hooks.json에 Agent Stop hooks 통합 | 1 | +40 lines |
| 2 | Agents 파일에서 hooks 섹션 제거 | 5 | -45 lines |
| 3 | Skills의 `${CLAUDE_PLUGIN_ROOT}` → `${PLUGIN_ROOT}` 변경 테스트 | 1 | 0 |
| 4 | 테스트 실패 시 Skills hooks도 hooks.json으로 이동 | 10 | +60 lines |

---

## 6. Functional Requirements

### FR-01: hooks.json Agent Stop Hooks 통합

**우선순위**: HIGH

`hooks/hooks.json`에 다음 Agent Stop hooks 추가:

```json
"Stop": [
  {
    "matcher": "gap-detector",
    "hooks": [{ "command": "node ${CLAUDE_PLUGIN_ROOT}/scripts/gap-detector-stop.js" }]
  },
  {
    "matcher": "pdca-iterator",
    "hooks": [{ "command": "node ${CLAUDE_PLUGIN_ROOT}/scripts/iterator-stop.js" }]
  },
  {
    "matcher": "code-analyzer",
    "hooks": [{ "command": "node ${CLAUDE_PLUGIN_ROOT}/scripts/analysis-stop.js" }]
  },
  {
    "matcher": "design-validator",
    "hooks": [{ "command": "node ${CLAUDE_PLUGIN_ROOT}/scripts/design-validator-pre.js" }]
  },
  {
    "matcher": "qa-monitor",
    "hooks": [{ "command": "node ${CLAUDE_PLUGIN_ROOT}/scripts/qa-stop.js" }]
  }
]
```

### FR-02: Agents 파일 hooks 섹션 제거

**우선순위**: HIGH

다음 파일에서 `hooks:` 섹션 제거:
- agents/gap-detector.md
- agents/pdca-iterator.md
- agents/code-analyzer.md
- agents/design-validator.md
- agents/qa-monitor.md

### FR-03: Skills hooks 경로 수정

**우선순위**: HIGH

Skills 파일의 hooks 경로 수정 방안 테스트:

**테스트 1**: `${PLUGIN_ROOT}` 변수 사용
```yaml
command: "node ${PLUGIN_ROOT}/scripts/pdca-skill-stop.js"
```

**테스트 2**: 실패 시 hooks.json으로 이동
```json
"Stop": [
  {
    "matcher": "Skill:pdca",
    "hooks": [{ "command": "node ${CLAUDE_PLUGIN_ROOT}/scripts/pdca-skill-stop.js" }]
  }
]
```

### FR-04: PreToolUse hooks 통합

**우선순위**: MEDIUM

Agents의 PreToolUse hooks도 hooks.json으로 이동:
- code-analyzer: Write|Edit 차단
- qa-monitor: Bash 전처리
- design-validator: Write 차단

---

## 7. Implementation Checklist

### Phase 1: Agents hooks 이동

- [ ] hooks/hooks.json에 Stop 섹션 추가
- [ ] gap-detector Stop hook 추가
- [ ] pdca-iterator Stop hook 추가
- [ ] code-analyzer Stop + PreToolUse hooks 추가
- [ ] qa-monitor Stop + PreToolUse + PostToolUse hooks 추가
- [ ] design-validator PreToolUse hook 추가

### Phase 2: Agents 파일 정리

- [ ] agents/gap-detector.md hooks 제거
- [ ] agents/pdca-iterator.md hooks 제거
- [ ] agents/code-analyzer.md hooks 제거
- [ ] agents/qa-monitor.md hooks 제거
- [ ] agents/design-validator.md hooks 제거

### Phase 3: Skills hooks 테스트

- [ ] skills/pdca/SKILL.md 경로 변수 테스트
- [ ] 실패 시 hooks.json으로 Skills Stop hooks 이동
- [ ] 모든 Skills hooks 검증

### Phase 4: 테스트

- [ ] `/pdca analyze` 실행 테스트
- [ ] `/pdca iterate` 실행 테스트
- [ ] `/code-review` 실행 테스트
- [ ] Agent 직접 호출 테스트
- [ ] 모든 Stop hooks 동작 확인

---

## 8. Risk Assessment

| 리스크 | 영향도 | 발생 확률 | 대응 방안 |
|-------|:------:|:--------:|----------|
| hooks.json Stop matcher 미지원 | HIGH | LOW | SubagentStop 이벤트명 확인 |
| Skills hooks 이동 후 동작 안함 | HIGH | MEDIUM | 점진적 마이그레이션, 롤백 계획 |
| Gemini CLI 호환성 문제 | MEDIUM | MEDIUM | 플랫폼별 분기 처리 |

---

## 9. Success Criteria

1. ✅ `/pdca analyze` 실행 시 gap-detector-stop.js 정상 호출
2. ✅ `/pdca iterate` 실행 시 iterator-stop.js 정상 호출
3. ✅ `/pdca report` 실행 시 pdca-skill-stop.js 정상 호출
4. ✅ 모든 Agent Stop hooks 정상 동작
5. ✅ 에러 메시지 "Cannot find module" 해결

---

## 10. Timeline

| Day | Task | 담당 |
|:---:|------|------|
| 1 | Phase 1-2: Agents hooks 이동 및 정리 | Claude |
| 1 | Phase 3: Skills hooks 테스트 | Claude |
| 1 | Phase 4: 전체 테스트 | User + Claude |

**예상 소요 시간**: 1일 (Hotfix)

---

## Related Documents

- [v1.4.4-comprehensive-enhancement.design.md](../02-design/features/v1.4.4-comprehensive-enhancement.design.md)
- [hooks/hooks.json](../../../hooks/hooks.json)
- [Claude Code Hooks Documentation](https://docs.anthropic.com/claude-code/hooks)

---

**Generated by**: bkit PDCA Plan Generator
**Timestamp**: 2026-01-27T08:30:00.000Z
